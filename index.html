<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FireSync – Inspection Prototype</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;padding:24px;max-width:900px;margin:auto;}
    h1{margin-bottom:8px}
    form{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin:18px 0;padding:12px;border:1px solid #ddd;border-radius:10px}
    form > div{display:flex;flex-direction:column;grid-column:span 3}
    form > div.full{grid-column:1/-1}
    label{font-weight:600;margin-bottom:4px}
    input,select,textarea,button{padding:8px;border:1px solid #ccc;border-radius:8px}
    textarea{min-height:70px}
    button{grid-column:1/-1;cursor:pointer}
    table{border-collapse:collapse;width:100%;margin-top:18px}
    th,td{border:1px solid #e5e5e5;padding:8px;text-align:left;font-size:14px}
    th{background:#fafafa}
    .ok{color:#137333}
    .err{color:#b3261e}
  </style>
</head>
<body>
  <h1>FireSync – New Inspection</h1>
  <div id="status"></div>

  <form id="inspectionForm" autocomplete="on">
    <div>
      <label for="inspector">Inspector</label>
      <input id="inspector" required placeholder="e.g., Lionel"/>
    </div>
    <div>
      <label for="address">Address</label>
      <input id="address" required placeholder="123 Main St"/>
    </div>
    <div>
      <label for="unit">Unit</label>
      <input id="unit" placeholder="Apt 4B"/>
    </div>

    <div>
      <label for="city">City</label>
      <input id="city" required placeholder="Ottawa"/>
    </div>
    <div>
      <label for="province">Province/State</label>
      <input id="province" required placeholder="ON"/>
    </div>
    <div>
      <label for="postal">Postal/ZIP</label>
      <input id="postal" placeholder="K1A 0B1"/>
    </div>

    <div>
      <label for="statusField">Status</label>
      <select id="statusField" required>
        <option value="">-- choose --</option>
        <option>Passed</option>
        <option>Failed</option>
        <option>Follow-up Needed</option>
      </select>
    </div>
    <div>
      <label for="smoke">Smoke Alarm</label>
      <select id="smoke" required>
        <option value="">-- choose --</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
        <option value="Unknown">Unknown</option>
      </select>
    </div>
    <div class="full">
      <label for="notes">Notes</label>
      <textarea id="notes" placeholder="Observations, hazards, photos link..."></textarea>
    </div>

    <button type="submit">Save Inspection</button>
  </form>

  <h2>Recent Inspections</h2>
  <table id="inspectionsTable">
    <thead>
      <tr>
        <th>When</th><th>Inspector</th><th>Address</th><th>Status</th><th>Smoke</th><th>Notes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Firebase (CDN) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getDatabase, ref, push, set, serverTimestamp,
      onValue, query, limitToLast
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // Your config
    const firebaseConfig = {
      apiKey: "AIzaSyBadst_lPQeAFM-zsnCRsBeLC-siE-FY04",
      authDomain: "firesync-84fdf.firebaseapp.com",
      databaseURL: "https://firesync-84fdf-default-rtdb.firebaseio.com",
      projectId: "firesync-84fdf",
      storageBucket: "firesync-84fdf.firebasestorage.app",
      messagingSenderId: "420471215291",
      appId: "1:420471215291:web:73bbe8ffdc33f32de0059e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- form submit ---
    const form = document.getElementById('inspectionForm');
    const statusEl = document.getElementById('status');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = "Saving...";
      statusEl.className = "";

      // Collect fields
      const data = {
        inspector: document.getElementById('inspector').value.trim(),
        address: document.getElementById('address').value.trim(),
        unit: document.getElementById('unit').value.trim(),
        city: document.getElementById('city').value.trim(),
        province: document.getElementById('province').value.trim(),
        postal: document.getElementById('postal').value.trim(),
        status: document.getElementById('statusField').value,
        smokeAlarm: document.getElementById('smoke').value,
        notes: document.getElementById('notes').value.trim(),
        createdAt: serverTimestamp()
      };

      // Minimal validation
      if (!data.inspector || !data.address || !data.city || !data.province || !data.status || !data.smokeAlarm) {
        statusEl.textContent = "Please fill all required fields.";
        statusEl.className = "err";
        return;
      }

      try {
        const newRef = push(ref(db, "inspections")); // auto-ID
        await set(newRef, data);
        statusEl.textContent = "Saved ✔";
        statusEl.className = "ok";
        form.reset();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Save failed: " + err.message;
        statusEl.className = "err";
      }
    });

    // --- live table of last 25 inspections ---
    const tbody = document.querySelector('#inspectionsTable tbody');
    const q = query(ref(db, "inspections"), limitToLast(25));
    onValue(q, (snap) => {
      const rows = [];
      snap.forEach(child => {
        const v = child.val();
        // createdAt is serverTimestamp → may be null on first render; show ISO if present
        const when = v.createdAt ? new Date(v.createdAt).toLocaleString() : '';
        rows.push(`
          <tr>
            <td>${when}</td>
            <td>${v.inspector ?? ""}</td>
            <td>${[v.address, v.unit].filter(Boolean).join(" ")} ${[v.city, v.province, v.postal].filter(Boolean).join(", ")}</td>
            <td>${v.status ?? ""}</td>
            <td>${v.smokeAlarm ?? ""}</td>
            <td>${(v.notes ?? "").replace(/</g,"&lt;")}</td>
          </tr>`);
      });
      tbody.innerHTML = rows.join("");
    });
  </script>
</body>
</html>
